# 测试依赖安装指南

> 3AI工作室 - TypeScript 测试环境配置指南

## 概述

本指南提供了完整的测试环境依赖安装说明，包括 Jest、Supertest、MongoDB Memory Server、Mongoose 和 Express 等常用测试库的安装和配置。

## 核心测试依赖

### 1. Jest 测试框架

```bash
# 安装 Jest 核心包
npm install --save-dev jest @types/jest

# TypeScript 支持
npm install --save-dev ts-jest typescript

# Jest 全局函数支持（可选）
npm install --save-dev @jest/globals
```

### 2. Supertest HTTP 测试

```bash
# 安装 Supertest
npm install --save-dev supertest @types/supertest
```

### 3. MongoDB 内存数据库

```bash
# 安装 MongoDB Memory Server
npm install --save-dev mongodb-memory-server

# MongoDB 驱动（如果需要）
npm install mongodb @types/mongodb
```

### 4. Mongoose ODM

```bash
# 安装 Mongoose
npm install mongoose @types/mongoose
```

### 5. Express 框架

```bash
# 安装 Express
npm install express @types/express

# Express 测试相关
npm install --save-dev @types/express-serve-static-core
```

## 完整安装命令

### 基础测试环境

```bash
# 一次性安装所有基础测试依赖
npm install --save-dev \
  jest @types/jest \
  ts-jest typescript \
  @jest/globals \
  supertest @types/supertest
```

### 完整 Web 应用测试环境

```bash
# 安装所有依赖（开发环境）
npm install --save-dev \
  jest @types/jest \
  ts-jest typescript \
  @jest/globals \
  supertest @types/supertest \
  mongodb-memory-server \
  @types/mongodb

# 安装生产依赖
npm install \
  express @types/express \
  mongoose @types/mongoose \
  mongodb
```

## 配置文件设置

### package.json 脚本配置

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --watchAll=false"
  },
  "jest": {
    "preset": "ts-jest",
    "testEnvironment": "node",
    "injectGlobals": true
  }
}
```

### Jest 配置文件 (jest.config.ts)

```typescript
import type { Config } from 'jest';

const config: Config = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  injectGlobals: true,
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  testMatch: [
    '**/__tests__/**/*.ts',
    '**/?(*.)+(spec|test).ts'
  ],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/*.test.ts'
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html']
};

export default config;
```

## 类型声明配置

### tsconfig.json 配置

```json
{
  "compilerOptions": {
    "typeRoots": [
      "./node_modules/@types",
      "./src/types",
      "./types",
      "./docs/04-模板/配置文件模板/types"
    ],
    "types": [
      "jest",
      "node",
      "supertest",
      "mongodb-memory-server",
      "mongoose",
      "express"
    ]
  },
  "include": [
    "src/**/*",
    "tests/**/*",
    "**/*.test.ts",
    "**/*.spec.ts"
  ]
}
```

## 环境特定安装

### Node.js 项目

```bash
# Node.js 基础测试环境
npm install --save-dev \
  jest @types/jest \
  ts-jest \
  @types/node
```

### React 项目

```bash
# React 测试环境
npm install --save-dev \
  jest @types/jest \
  ts-jest \
  @testing-library/react \
  @testing-library/jest-dom \
  @testing-library/user-event
```

### Vue 项目

```bash
# Vue 测试环境
npm install --save-dev \
  jest @types/jest \
  ts-jest \
  @vue/test-utils \
  vue-jest
```

## 常见问题解决

### 1. Jest 全局函数找不到

**问题**: `describe`, `test`, `expect` 等函数找不到

**解决方案**:
```typescript
// 方案 1: 在 jest.config.ts 中启用全局注入
export default {
  injectGlobals: true
};

// 方案 2: 显式导入
import { describe, test, expect } from '@jest/globals';
```

### 2. 模块类型声明找不到

**问题**: 找不到模块 'supertest' 或其相应的类型声明

**解决方案**:
```bash
# 安装类型声明包
npm install --save-dev @types/supertest

# 或使用自定义类型声明文件
# 参考 types/test-dependencies.d.ts
```

### 3. MongoDB Memory Server 启动失败

**问题**: MongoMemoryServer 无法启动

**解决方案**:
```typescript
// 在测试设置中配置超时
jest.setTimeout(60000);

// 或在 jest.config.ts 中设置
export default {
  testTimeout: 60000
};
```

## 版本兼容性

### 推荐版本组合

```json
{
  "devDependencies": {
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.0.0",
    "typescript": "^5.0.0",
    "supertest": "^6.3.0",
    "@types/supertest": "^2.0.12",
    "mongodb-memory-server": "^9.0.0"
  },
  "dependencies": {
    "express": "^4.18.0",
    "@types/express": "^4.17.0",
    "mongoose": "^7.0.0",
    "@types/mongoose": "^5.11.0"
  }
}
```

## 最佳实践

### 1. 分层安装

```bash
# 第一步：基础测试框架
npm install --save-dev jest @types/jest ts-jest

# 第二步：HTTP 测试
npm install --save-dev supertest @types/supertest

# 第三步：数据库测试
npm install --save-dev mongodb-memory-server

# 第四步：应用框架
npm install express mongoose
```

### 2. 环境隔离

```bash
# 开发环境
npm install --save-dev [测试相关包]

# 生产环境
npm install --production
```

### 3. 版本锁定

```bash
# 使用 package-lock.json 锁定版本
npm ci  # 在 CI/CD 中使用
```

## 验证安装

### 创建测试文件验证

```typescript
// test/setup.test.ts
import { describe, test, expect } from '@jest/globals';

describe('测试环境验证', () => {
  test('Jest 基础功能', () => {
    expect(1 + 1).toBe(2);
  });

  test('异步测试支持', async () => {
    const result = await Promise.resolve('success');
    expect(result).toBe('success');
  });
});
```

### 运行验证

```bash
# 运行测试验证安装
npm test

# 检查覆盖率
npm run test:coverage
```

---

**3AI工作室** - 提供完整的 TypeScript 测试环境解决方案