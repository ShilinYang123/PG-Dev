# 紧急停止机制使用指南

## 概述

紧急停止机制是当发现可能违背核心规范时立即停止操作的应急措施系统。该机制能够在检测到违规行为、危险操作或系统异常时自动触发，确保项目的安全性和规范性。

## 核心功能

### 1. 自动检测与停止
- **核心规范文件检查**: 验证5个核心规范文件的完整性
- **受保护文件监控**: 防止对关键系统文件的未授权操作
- **危险操作识别**: 检测可能造成损害的操作模式
- **实时状态监控**: 持续监控系统状态和操作合规性

### 2. 紧急响应机制
- **立即停止**: 检测到违规时立即终止当前操作
- **进程终止**: 自动终止相关子进程
- **状态锁定**: 创建停止标志防止后续操作
- **详细记录**: 完整记录停止原因和系统状态

### 3. 恢复与重启
- **安全恢复**: 验证问题解决后安全恢复操作
- **状态清理**: 清除停止标志和临时文件
- **完整性验证**: 确保系统完全恢复正常

## 系统架构

### 保护层级

#### 第一层：核心规范文件保护
- `docs/01-设计/开发任务书.md`
- `docs/01-设计/技术方案.md`
- `docs/01-设计/项目架构设计.md`
- `docs/03-管理/规范与流程.md`
- `docs/03-管理/核心规范永久遵守机制.md`

#### 第二层：系统工具保护
- `tools/update_structure.py`
- `tools/check_structure.py`
- `tools/finish.py`
- `操作前强制检查.py`
- `tools\规范违背预防系统.py`
- `tools\紧急停止机制.py`

#### 第三层：危险操作检测
- 批量删除操作
- 强制覆盖操作
- 核心文件修改
- 绕过检查操作

## 使用方法

### 命令行接口

#### 基础检查
```bash
# 执行系统状态检查
python tools\紧急停止机制.py

# 执行全面检查
python tools\紧急停止机制.py --check
```

#### 特定操作检查
```bash
# 检查文件操作
python tools\紧急停止机制.py --check --file "path/to/file" --operation "修改"

# 检查危险操作
python tools\紧急停止机制.py --check --description "批量删除旧文件"

# 综合检查
python tools\紧急停止机制.py --check --file "tools/update_structure.py" --operation "修改" --description "更新核心工具"
```

#### 紧急停止
```bash
# 手动触发紧急停止
python tools\紧急停止机制.py --stop "发现严重违规行为"
```

#### 恢复操作
```bash
# 恢复正常操作
python tools\紧急停止机制.py --resume
```

### 程序化调用

```python
from 紧急停止机制 import 紧急停止机制

# 创建实例
停止机制 = 紧急停止机制()

# 执行检查
检查结果, 检查消息 = 停止机制.全面检查(
    文件路径="docs/01-设计/开发任务书.md",
    操作类型="修改",
    操作描述="更新项目需求"
)

if not 检查结果:
    # 触发紧急停止
    停止机制.执行紧急停止(f"检查失败: {检查消息}")
else:
    print("检查通过，可以继续操作")
```

## 检查结果说明

### 通过状态
- ✅ **检查通过**: 所有验证项目均符合要求
- ✅ **系统状态正常**: 无违规行为检测

### 失败状态
- ❌ **核心文件缺失**: 关键规范文件不存在
- ❌ **受保护文件操作**: 尝试修改系统关键文件
- ❌ **危险操作检测**: 发现可能造成损害的操作
- ❌ **紧急停止状态**: 系统处于停止状态

## 紧急停止流程

### 触发条件
1. **核心规范文件缺失或损坏**
2. **尝试修改受保护的系统文件**
3. **检测到危险操作模式**
4. **手动触发紧急停止**
5. **系统异常或进程错误**

### 停止执行步骤
1. **立即记录**: 详细记录停止原因和时间
2. **创建标志**: 生成 `.emergency_stop` 停止标志文件
3. **终止进程**: 安全终止所有相关子进程
4. **生成报告**: 创建详细的紧急停止报告
5. **用户通知**: 显示停止信息和后续建议

### 停止后状态
- 所有后续操作将被阻止
- 系统进入安全锁定模式
- 生成完整的事件记录
- 提供恢复操作指导

## 恢复操作流程

### 恢复前检查
1. **问题解决确认**: 确保导致停止的问题已解决
2. **规范文件验证**: 检查所有核心规范文件完整性
3. **系统状态评估**: 评估当前系统状态

### 恢复执行步骤
1. **运行恢复命令**: `python tools\紧急停止机制.py --resume`
2. **自动验证**: 系统自动执行全面检查
3. **清理状态**: 移除停止标志和临时文件
4. **确认恢复**: 验证系统完全恢复正常

## 日志系统

### 日志文件
- **紧急停止日志**: `logs/紧急停止.log`
- **违规检测日志**: `logs/违规检测.log`
- **紧急停止报告**: `logs/紧急停止报告_YYYYMMDD_HHMMSS.md`

### 日志级别
- **INFO**: 一般信息记录
- **ERROR**: 错误信息记录
- **CRITICAL**: 紧急停止事件

## 集成到工作流程

### 操作前检查集成
```python
# 在执行任何重要操作前
停止机制 = 紧急停止机制()
检查结果, 消息 = 停止机制.全面检查(文件路径, 操作类型, 操作描述)

if not 检查结果:
    停止机制.执行紧急停止(f"操作前检查失败: {消息}")
    return False

# 继续执行操作
```

### 异常处理集成
```python
try:
    # 执行操作
    执行危险操作()
except Exception as e:
    停止机制.执行紧急停止(f"操作异常: {str(e)}")
    raise
```

## 信号处理

### 支持的信号
- **SIGINT** (Ctrl+C): 用户中断信号
- **SIGTERM**: 程序终止信号

### 信号响应
- 自动触发紧急停止
- 记录信号接收事件
- 安全清理和退出

## 故障排除

### 常见问题

#### 1. 无法恢复操作
**症状**: 运行 `--resume` 后仍然无法恢复
**解决方案**:
- 检查核心规范文件是否完整
- 确认导致停止的问题已解决
- 手动删除 `.emergency_stop` 文件后重试

#### 2. 误触发紧急停止
**症状**: 正常操作被错误阻止
**解决方案**:
- 检查操作是否真的符合规范
- 确认文件路径和操作描述正确
- 如确认无误，可手动恢复操作

#### 3. 日志记录失败
**症状**: 无法写入日志文件
**解决方案**:
- 检查 `logs` 目录权限
- 确保磁盘空间充足
- 检查文件是否被其他程序占用

### 调试模式
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 执行检查
停止机制 = 紧急停止机制()
结果 = 停止机制.全面检查()
```

## 维护和更新

### 定期维护
1. **日志清理**: 定期清理过期的日志文件
2. **配置更新**: 根据项目变化更新保护文件列表
3. **功能测试**: 定期测试紧急停止和恢复功能

### 配置更新
```python
# 更新受保护文件列表
停止机制.受保护文件.append("新的重要文件.py")

# 更新危险操作关键词
停止机制.危险操作关键词.extend(["新危险操作", "另一个危险操作"])
```

## 最佳实践

### 1. 预防性使用
- 在执行任何重要操作前先运行检查
- 将检查集成到自动化脚本中
- 定期执行系统状态检查

### 2. 快速响应
- 发现问题立即停止，不要尝试继续
- 仔细阅读停止报告中的建议
- 在恢复前确保问题完全解决

### 3. 文档记录
- 保留所有紧急停止事件的记录
- 分析停止原因，改进预防措施
- 更新操作流程以避免重复问题

### 4. 团队协作
- 确保所有团队成员了解紧急停止机制
- 建立清晰的问题上报流程
- 定期培训和演练应急响应

## 安全注意事项

### 权限管理
- 确保紧急停止机制具有足够的系统权限
- 限制对停止标志文件的访问权限
- 保护日志文件不被恶意修改

### 数据保护
- 紧急停止不会删除用户数据
- 所有操作都有完整的日志记录
- 支持安全的状态恢复

### 系统稳定性
- 紧急停止机制本身不会造成系统不稳定
- 支持优雅的进程终止
- 提供可靠的恢复机制

---

**技术负责人**: 雨俊  
**创建时间**: 2025-01-12  
**版本**: 1.0.0  
**最后更新**: 2025-01-12

*本文档是紧急停止机制的完整使用指南，请严格按照指南操作以确保系统安全。*