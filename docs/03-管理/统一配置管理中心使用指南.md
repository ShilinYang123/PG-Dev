# 统一配置管理中心使用指南

## 概述

统一配置管理中心是PMC全流程管理系统的核心配置管理组件，提供了集中化的配置管理、环境变量处理、路径管理和配置验证功能。

## 架构设计

### 核心组件

1. **ConfigManager** - 配置文件管理器
2. **EnvironmentManager** - 环境配置管理器
3. **PathManager** - 路径管理器
4. **ConfigValidator** - 配置验证器
5. **DefaultConfigProvider** - 默认配置提供器
6. **SettingsManager** - 统一设置管理器

### 目录结构

```
project/src/config/
├── __init__.py              # 模块初始化和导出接口
├── config_manager.py        # 配置文件管理
├── environment.py           # 环境配置管理
├── path_manager.py          # 路径管理
├── validator.py             # 配置验证
├── settings.py              # 统一设置管理
└── cli.py                   # 命令行工具
```

## 快速开始

### 1. 基本使用

```python
from src.config import (
    get_settings_manager,
    get_settings,
    init_config
)

# 初始化配置
init_config(environment='development')

# 获取配置管理器
settings_manager = get_settings_manager()

# 获取应用设置
settings = get_settings()

print(f"项目名称: {settings.project_name}")
print(f"当前环境: {settings.environment}")
print(f"数据库URL: {settings.database_url}")
```

### 2. 环境配置

```python
from src.config import get_environment_manager

# 获取环境管理器
env_manager = get_environment_manager()

# 切换环境
env_manager.set_current_environment('production')

# 获取当前环境
current_env = env_manager.get_current_environment()
print(f"当前环境: {current_env}")

# 获取环境配置
env_config = env_manager.get_environment_config()
print(f"调试模式: {env_config.debug}")
```

### 3. 路径管理

```python
from src.config import get_path_manager

# 获取路径管理器
path_manager = get_path_manager()

# 获取项目路径
project_root = path_manager.get_path('project_root')
upload_dir = path_manager.get_path('uploads')
log_dir = path_manager.get_path('logs')

# 添加自定义路径
path_manager.add_path('custom_data', '/path/to/custom/data')

# 创建目录
path_manager.ensure_directory('uploads')
path_manager.ensure_directory('logs')
```

## 配置文件格式

### 主配置文件 (project_config.yaml)

```yaml
# 项目基本信息
project:
  name: "PMC全流程管理系统"
  version: "1.0.0"
  description: "PMC全流程管理系统"
  author: "PMC Team"
  license: "MIT"

# 应用配置
application:
  host: "0.0.0.0"
  port: 8000
  debug: true
  environment: "development"
  api_v1_prefix: "/api/v1"
  cors_origins:
    - "http://localhost:3000"
    - "http://localhost:3001"

# 数据库配置
database:
  url: "postgresql://postgres:password@localhost:5432/pmc_db"
  sqlite_url: "sqlite:///./pmc.db"
  pool_size: 5
  max_overflow: 10
  pool_timeout: 30
  pool_recycle: 3600

# 安全配置
security:
  secret_key: "your-secret-key-here"
  algorithm: "HS256"
  access_token_expire_minutes: 30
  bcrypt_rounds: 12

# 路径配置
paths:
  project_root: "s:/PG-PMC"
  docs: "s:/PG-PMC/docs"
  logs: "s:/PG-PMC/logs"
  uploads: "s:/PG-PMC/uploads"
  temp: "s:/PG-PMC/temp"
  cache: "s:/PG-PMC/cache"

# 日志配置
logging:
  level: "INFO"
  file: "logs/pmc.log"
  max_file_size: 10485760  # 10MB
  backup_count: 5
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# 文件配置
file:
  upload_dir: "uploads"
  max_file_size: 10485760  # 10MB
  allowed_file_types:
    - ".jpg"
    - ".jpeg"
    - ".png"
    - ".gif"
    - ".pdf"
    - ".xlsx"
    - ".xls"
    - ".csv"
  chunk_size: 1048576  # 1MB

# Redis配置
redis:
  url: "redis://localhost:6379/0"
  timeout: 300
  max_connections: 10

# 外部服务配置
external_services:
  smtp:
    server: ""
    port: 587
    username: ""
    password: ""
    use_tls: true
    from_email: ""
    from_name: "PMC系统"
```

## 环境变量

### 后端环境变量 (.env)

```bash
# 数据库配置
DATABASE_URL=postgresql://postgres:password@localhost:5432/pmc_db

# 安全配置
SECRET_KEY=your-secret-key-here

# 环境配置
ENVIRONMENT=development
DEBUG=true

# 日志配置
LOG_LEVEL=INFO

# Redis配置
REDIS_URL=redis://localhost:6379/0

# SMTP配置
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=
EMAILS_FROM_EMAIL=
```

### 前端环境变量 (.env.local)

```bash
# API配置
REACT_APP_API_BASE_URL=http://localhost:8000
REACT_APP_API_VERSION=/api/v1
REACT_APP_API_TIMEOUT=30000

# 功能开关
REACT_APP_ENABLE_MOCK=false
REACT_APP_ENABLE_ANALYTICS=false

# UI配置
REACT_APP_PRIMARY_COLOR=#1890ff
REACT_APP_LAYOUT=side
REACT_APP_FIXED_HEADER=true
REACT_APP_FIXED_SIDER=true

# 分页配置
REACT_APP_PAGE_SIZE=20
REACT_APP_MAX_FILE_SIZE=10485760
```

## 命令行工具

### 安装和使用

```bash
# 进入项目目录
cd s:/PG-PMC/project

# 使用Python运行CLI工具
python -m src.config.cli --help
```

### 常用命令

#### 1. 初始化配置

```bash
# 初始化开发环境配置
python -m src.config.cli init --environment development

# 初始化生产环境配置
python -m src.config.cli init --environment production --config-file /path/to/config.yaml
```

#### 2. 验证配置

```bash
# 验证当前配置
python -m src.config.cli validate
```

#### 3. 显示配置

```bash
# 显示所有配置
python -m src.config.cli show

# 显示特定部分配置
python -m src.config.cli show --section database --format json

# 以YAML格式显示配置
python -m src.config.cli show --format yaml
```

#### 4. 导出环境变量

```bash
# 导出到控制台
python -m src.config.cli export

# 导出到.env文件
python -m src.config.cli export --output .env --format env

# 导出为JSON格式
python -m src.config.cli export --output config.json --format json
```

#### 5. 创建.env文件

```bash
# 创建开发环境.env文件
python -m src.config.cli create-env --environment development

# 创建生产环境.env文件
python -m src.config.cli create-env --environment production --output .env.prod
```

#### 6. 健康检查

```bash
# 执行配置健康检查
python -m src.config.cli health
```

## API接口

### 前端配置接口

```http
GET /api/v1/config/frontend
```

返回前端应用所需的配置信息。

### 后端配置接口

```http
GET /api/v1/config/backend
```

返回后端应用的配置信息（管理员接口）。

### 配置健康检查

```http
GET /api/v1/config/health
```

返回配置系统的健康状态。

### 配置验证

```http
GET /api/v1/config/validation
```

返回配置验证结果。

### 环境变量配置

```http
GET /api/v1/config/env-vars
```

返回环境变量配置（用于生成.env文件）。

## 集成指南

### 后端集成

#### 1. 更新FastAPI配置

```python
# app/core/config.py
from src.config import get_settings, get_settings_manager

# 获取统一配置
unified_settings = get_settings()
settings_manager = get_settings_manager()

class Settings(BaseSettings):
    def __init__(self, **kwargs):
        # 使用统一配置的值
        if unified_settings:
            kwargs.setdefault('PROJECT_NAME', unified_settings.project_name)
            kwargs.setdefault('DATABASE_URL', unified_settings.database_url)
            # ... 其他配置
        
        super().__init__(**kwargs)
```

#### 2. 数据库连接

```python
# app/db/database.py
from src.config import get_database_url

# 使用统一配置的数据库URL
DATABASE_URL = get_database_url()
engine = create_engine(DATABASE_URL)
```

### 前端集成

#### 1. 配置管理器

```typescript
// src/config/index.ts
import { ConfigManager } from './config-manager';

// 创建配置管理器实例
const configManager = new ConfigManager();

// 导出配置
export const config = configManager.getConfig();
export const apiConfig = configManager.getApiConfig();
```

#### 2. API客户端

```typescript
// src/services/api.ts
import axios from 'axios';
import { apiConfig } from '../config';

// 创建API客户端
const apiClient = axios.create(apiConfig);
```

## 最佳实践

### 1. 环境管理

- **开发环境**: 使用SQLite数据库，启用调试模式
- **测试环境**: 使用独立的测试数据库，禁用调试模式
- **生产环境**: 使用PostgreSQL数据库，启用安全配置

### 2. 配置安全

- 敏感信息（密码、密钥）使用环境变量
- 生产环境配置文件不包含敏感信息
- 定期轮换密钥和密码

### 3. 配置验证

- 应用启动时验证配置
- 使用CLI工具定期检查配置健康状态
- 配置变更后执行验证

### 4. 版本控制

- 配置文件模板纳入版本控制
- 实际配置文件添加到.gitignore
- 使用配置文档记录变更

## 故障排除

### 常见问题

#### 1. 配置文件未找到

```
错误: 配置文件不存在: /path/to/config.yaml
```

**解决方案**:
- 检查配置文件路径是否正确
- 使用CLI工具初始化配置: `python -m src.config.cli init`

#### 2. 环境变量未设置

```
警告: 环境变量 DATABASE_URL 未设置
```

**解决方案**:
- 创建.env文件: `python -m src.config.cli create-env`
- 手动设置环境变量

#### 3. 配置验证失败

```
错误: 生产环境必须设置安全的SECRET_KEY
```

**解决方案**:
- 检查配置验证结果: `python -m src.config.cli validate`
- 根据错误信息修正配置

#### 4. 路径权限问题

```
错误: 无法创建目录: /path/to/uploads
```

**解决方案**:
- 检查目录权限
- 使用管理员权限运行
- 修改路径配置

### 调试技巧

#### 1. 启用调试日志

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### 2. 检查配置加载

```python
from src.config import get_settings_manager

settings_manager = get_settings_manager()
if settings_manager:
    print("配置管理器加载成功")
    print(f"配置文件: {settings_manager.config_manager.config_file}")
else:
    print("配置管理器加载失败")
```

#### 3. 验证环境配置

```bash
# 检查环境变量
echo $DATABASE_URL
echo $SECRET_KEY

# 验证配置
python -m src.config.cli validate
```

## 更新日志

### v1.0.0 (2024-01-XX)

- 初始版本发布
- 实现统一配置管理中心
- 支持多环境配置
- 提供CLI工具
- 集成前后端配置

## 参考资料

- [FastAPI配置文档](https://fastapi.tiangolo.com/advanced/settings/)
- [Pydantic设置管理](https://pydantic-docs.helpmanual.io/usage/settings/)
- [React环境变量](https://create-react-app.dev/docs/adding-custom-environment-variables/)
- [YAML配置格式](https://yaml.org/spec/1.2/spec.html)